'use strict';

{
  const wordsbase = [
    'neko',
    'pasokonn',
    'memori-',
    'dhisupurei',
    'ki-bo-do',
    'migikurikku',
    'dengennonn', 
  ];
  const textsbase = [
    "çŒ«",
    "ãƒ‘ã‚½ã‚³ãƒ³",
    "ãƒ¡ãƒ¢ãƒªãƒ¼",
    "ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤",
    "ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰",
    "å³ã‚¯ãƒªãƒƒã‚¯",
    "é›»æºã‚ªãƒ³",
  ];

  const wordsbase_h = [
    "huri-ennginianinaru",
    "RubyOnRailshahure-muwa-kudesu",
    "puroguraminngugakusyuuwosusumeru",
    "ro-karukannkyounosakuseihatoraburugaooi",
    "Javascriptwotukattemiru",
    "CSSdemoziirowokaeru",
    "HTMLwokakunohatanosii",
    "MacOSdekaihatusuru",
  ];
  const textsbase_h = [
    "ãƒ•ãƒªãƒ¼ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ãªã‚‹",
    "RubyOnRailsã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™",
    "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ã‚’é€²ã‚ã‚‹",
    "ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ä½œæˆã¯ãƒˆãƒ©ãƒ–ãƒ«ãŒå¤šã„",
    "Javascriptã‚’ä½¿ã£ã¦ã¿ã‚‹",
    "CSSã§æ–‡å­—è‰²ã‚’å¤‰ãˆã‚‹",
    "HTMLã‚’æ›¸ãã®ã¯æ¥½ã—ã„",
    "MacOSã§é–‹ç™ºã™ã‚‹",
  ];

  const wordsbase_c = [
    "nya-",
    "gorogoro",
    "sya-!",
    "unya-o-",
    "nya-nn,nya-nn",
    "gyaxtu",
    "nyaxtu",
    "kakkakkaxtu",
  ];
  const textsbase_c = [
    "ã«ã‚ƒãƒ¼",
    "ã‚´ãƒ­ã‚´ãƒ­",
    "ã‚·ãƒ£ãƒ¼ï¼",
    "ã‚¦ãƒ‹ãƒ£ãƒ¼ã‚ªãƒ¼",
    "ãƒ‹ãƒ£ãƒ¼ãƒ³ã€ãƒ‹ãƒ£ãƒ¼ãƒ³",
    "ã‚®ãƒ£ãƒƒ",
    "ãƒ‹ãƒ£ãƒƒ",
    "ã‚«ãƒƒã‚«ãƒƒã‚«ãƒƒ",
  ];

  let words;
  let texts;

  let num;
  let word;
  let text;
  let loc = 0;
  let startTime;
  let isPlaying = false;
  let target = document.getElementById('target');
  let label = document.getElementById('label');
  // let best = document.getElementById('best');
  let prescore = 999.99;

  document.getElementById('backtype').style.display = 'none';

  const mode = Number(document.getElementById('mode').value);
  const user_id = Number(document.getElementById('user_id').value);
  const best_record = Number(document.getElementById('best_record').value);

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼é–¢é€£
  // const timer = document.getElementById('timer');
  const btn = document.getElementById('btn');
  let endTime;
  let intervalId;
  let isStarting = false;


  window.onload = function(){
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œã—ãŸã„å‡¦ç†
    document.getElementById('target').reset();
    document.getElementById('label').reset();
    prescore = 999.99;
  }

  // æ±ç”¨é–¢æ•°
  function myfunc() {
  }
  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å•é¡Œç”¨ã®é…åˆ—ã‚»ãƒƒãƒˆ
  function setArray() {

    switch(mode){
      case 1:   // Easyãƒ¢ãƒ¼ãƒ‰
        words = Array.from(wordsbase);
        texts = Array.from(textsbase);
        break;

      case 2:   // Hardãƒ¢ãƒ¼ãƒ‰
        words = Array.from(wordsbase_h);
        texts = Array.from(textsbase_h);
        break;
      
      case 3:   // çŒ«ãƒ¢ãƒ¼ãƒ‰
        words = Array.from(wordsbase_c);
        texts = Array.from(textsbase_c);
        break;
      
      default:
        // Easyãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãŠã
        words = Array.from(wordsbase);
        texts = Array.from(textsbase);
        break;
    }
  } 
  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å•é¡Œã®ãƒ©ãƒ™ãƒ«ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š
  function setWord() {
    num = Math.floor(Math.random() * words.length);

    word = words.splice(num, 1)[0];
    text = texts.splice(num, 1)[0];
    
    target.style.color = "#000000";
    target.textContent = word;
    label.textContent = text;
    // best.textContent = "ã€€";
    loc = 0;
  }
  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
  function startCountDown() {
    if( isStarting === true){
      return;
    }
    label.textContent = "ã€€";
    isStarting = true;

    document.getElementById('backtype').style.display = 'none';
    document.getElementById('sel_mode').style.display = 'none';
    document.getElementById('chk_score').style.display = 'none';
    label.textContent ="ã€€";
    target.textContent = "ã€€";

    // (1) çµ‚äº†æ™‚åˆ»ã‚’æ±‚ã‚ã‚‹
    endTime = new Date().getTime() + 3 * 1000;

    // (2) æ®‹ã‚Šæ™‚é–“ã‚’æ±‚ã‚ã‚‹
    intervalId = setInterval(check, 100);
  }
  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹æ™‚ã®å‡¦ç†
  function startTyping() { 
    if (isPlaying === true) {
      return;
    }
    
    document.getElementById('backtype').style.display = 'none';
    isPlaying = true;
    startTime = Date.now();
    setArray();
    setWord();
  }

  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ã®ãƒˆãƒªã‚¬ãƒ¼
  document.addEventListener('keydown', e => {
    if (e.code === "Space") {      
      startCountDown();
    }
  });
  
  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­ã®å‹•ä½œ
  document.addEventListener('keydown', e => {
    if (e.key !== word[loc]) {
      return;
    }
    
    loc++;

    target.textContent = '_'.repeat(loc) + word.substring(loc);

    // æœ€çµ‚æ–‡å­—ã¾ã§åˆ°é”ã—ãŸã‚‰æ¬¡ã®ãƒ¯ãƒ¼ãƒ‰ã¸
    if ( loc === word.length) {
      if ( words.length === 0){
        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(2);
        label.textContent = `Finished! ${elapsedTime} seconds!`;
        target.textContent = "ã€€";
        
        // ã‚‚ã†ä¸€å›ãƒœã‚¿ãƒ³æŠ¼ã—ãŸæ™‚ã«ã€ŒBEST SCORE!!ã€ã¨å‡ºã•ãªã„ãŸã‚ã®å‡¦ç†
        if ( elapsedTime < prescore){
          prescore = elapsedTime;
        }        
        
        if ( elapsedTime < best_record){
          if ( elapsedTime <= prescore ){
            target.style.color = "#ff0000";
            target.textContent = "ğŸˆ BEST SCORE!! ğŸˆ";
          }
        }

        document.getElementById('backtype').style.display = "inline";
        document.getElementById('sel_mode').style.display = "inline";
        document.getElementById('chk_score').style.display = "inline";


        $.ajax({
          type: 'patch',
          url: `/users/${user_id}/save_record`,
          data: { record: elapsedTime, mode: mode },
          dataType: 'json'
        })

        return;
      }

      setWord();
    }
  });

  document.getElementById("backtype").onclick = function() {

    isStarting = false;
    // isPlaying = false;
    // isStarting = false;
    // document.getElementById('backtype').style.display = 'none';
    // label.textContent ="";
    // best.textContent = "";

    startCountDown();
  };

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†
  function check() {
    // æ®‹ã‚Šæ™‚é–“ = çµ‚äº†æ™‚åˆ» - ç¾åœ¨æ™‚åˆ»
    let countdown = endTime - new Date().getTime();

    // (3) ã‚¿ã‚¤ãƒãƒ¼ã®çµ‚äº†
    if (countdown < 0) {
      clearInterval(intervalId);
      countdown = 3 * 1000;

      label.textContent = "ã€€";
      isPlaying = false;
      startTyping();
      return;
    }

    const totalSeconds = Math.floor(countdown / 1000);
    // 80ç§’ â†’ 1åˆ†20ç§’
    // 80 Ã· 60 = 1 ä½™ã‚Š 20
    // 80 / 60 = 1.33333.... â†’ 1
    // 80 % 60 = 20
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60 + 1;

    const minutesFormatted = String(minutes).padStart(2, '0');
    const secondsFormatted = String(seconds).padStart(1, '0');

    label.textContent = `ğŸ˜º é–‹å§‹ã¾ã§ ${secondsFormatted}ç§’ ğŸ˜º`;
    // label.textContent = `${minutesFormatted}:${secondsFormatted}`;
  }
  
  
  // document.addEventListener('keydown', e => {
  //   if (e.code === "Enter") {
  //     // (1) çµ‚äº†æ™‚åˆ»ã‚’æ±‚ã‚ã‚‹
  //     endTime = new Date().getTime() + 3 * 1000;

  //     // (2) æ®‹ã‚Šæ™‚é–“ã‚’æ±‚ã‚ã‚‹
  //     intervalId = setInterval(check, 100);
  //     }
  // });
  
}